# åè®®å±‚ä¸ä¼ è¾“å±‚æ¶æ„é‡æ„ä¼˜åŒ–è®°å½•

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†å¯¹ `chat-go` é¡¹ç›®ä¸­ `protocol` å’Œ `transport` åŒ…çš„æ·±åº¦é‡æ„è¿‡ç¨‹ï¼Œè§£å†³äº†åŸæœ‰è®¾è®¡ä¸­çš„èŒè´£æ··ä¹±ã€è¾¹ç•Œä¸æ¸…ã€å®ç°ä¸å®Œæ•´ç­‰æ ¸å¿ƒæ¶æ„é—®é¢˜ã€‚

## åŸæœ‰æ¶æ„é—®é¢˜åˆ†æ

### 1. Protocol åŒ…è®¾è®¡ç¼ºé™·

#### èŒè´£æ··ä¹±é—®é¢˜
```go
// åŸæœ‰é—®é¢˜ä»£ç ç¤ºä¾‹
type Protocol struct {
    mu             sync.RWMutex
    handlers       map[MessageType]MessageHandler  // è·¯ç”±èŒè´£
    defaultHandler MessageHandler                  // è·¯ç”±èŒè´£  
    Codec          MessageCodec                    // ç¼–è§£ç èŒè´£
}
```

**é—®é¢˜ç‚¹ï¼š**
- ä¸€ä¸ªç»“æ„ä½“æ‰¿æ‹…äº†æ¶ˆæ¯æ ¼å¼å®šä¹‰ã€ç¼–è§£ç ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±åˆ†å‘ä¸‰é‡èŒè´£
- è¿åäº†å•ä¸€èŒè´£åŸåˆ™ (SRP)
- ä½¿å¾—ä»£ç éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤

#### å…¨å±€çŠ¶æ€é—®é¢˜
```go
// åŸæœ‰é—®é¢˜ä»£ç 
var DefaultProtocol *Protocol

func init() {
    DefaultProtocol = NewProtocol(CodecJson)
    DefaultProtocol.SetDefaultHandler(DefaultProtocol.textHandler)
}
```

**é—®é¢˜ç‚¹ï¼š**
- ä½¿ç”¨å…¨å±€å˜é‡ï¼Œé€ æˆç»„ä»¶é—´ä¸å¿…è¦çš„è€¦åˆ
- éš¾ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•å’Œå¹¶å‘æµ‹è¯•
- ä¸æ”¯æŒå¤šå®ä¾‹æˆ–ä¸åŒé…ç½®çš„åœºæ™¯

#### å®ç°ä¸å®Œæ•´é—®é¢˜
```go
// å¤§é‡ç©ºå®ç°å’Œæ³¨é‡Šä»£ç 
func (d *Protocol) textHandler(env *Envelope) error {
    // ç©ºå®ç°
    return nil
}
```

### 2. Transport åŒ…è®¾è®¡ç¼ºé™·

#### ä¸šåŠ¡é€»è¾‘æ··å…¥é—®é¢˜
```go
// åŸæœ‰é—®é¢˜ä»£ç ç¤ºä¾‹
type tcpConn struct {
    id         string
    conn       net.Conn
    client     *chat.Client  // ä¸šåŠ¡å±‚ä¾èµ–
    // ...
}

func getClient(sess Session) *chat.Client {
    if ts, ok := sess.(*tcpConn); ok {
        return ts.client  // ä¼ è¾“å±‚ç›´æ¥æš´éœ²ä¸šåŠ¡å¯¹è±¡
    }
    return nil
}
```

**é—®é¢˜ç‚¹ï¼š**
- ä¼ è¾“å±‚ç›´æ¥ä¾èµ–ä¸šåŠ¡å±‚çš„ `chat.Client`
- è¿åäº†åˆ†å±‚æ¶æ„åŸåˆ™
- ä½¿å¾—ä¼ è¾“å±‚æ— æ³•ç‹¬ç«‹æµ‹è¯•å’Œå¤ç”¨

#### æ¥å£å®ç°ä¸ä¸€è‡´
```go
// TCP å’Œ WebSocket å®ç°å·®å¼‚å¾ˆå¤§ï¼Œç¼ºä¹ç»Ÿä¸€æŠ½è±¡
type tcpConn struct { /* ... */ }
type wsConn struct { /* ... */ }
```

**é—®é¢˜ç‚¹ï¼š**
- ä¸åŒä¼ è¾“æ–¹å¼çš„ Session å®ç°å·®å¼‚å¾ˆå¤§
- ç¼ºä¹ç»Ÿä¸€çš„æŠ½è±¡åŸºç±»
- ä»£ç é‡å¤ï¼Œç»´æŠ¤å›°éš¾

## é‡æ„è§£å†³æ–¹æ¡ˆ

### 1. Protocol å±‚èŒè´£åˆ†ç¦»

#### åˆ›å»ºç‹¬ç«‹çš„æ¶ˆæ¯è·¯ç”±å™¨
```go
// æ–°æ–‡ä»¶: internal/protocol/router.go
type MessageRouter struct {
    mu             sync.RWMutex
    handlers       map[MessageType]MessageHandler
    defaultHandler MessageHandler
}

func NewMessageRouter() *MessageRouter {
    return &MessageRouter{
        handlers: make(map[MessageType]MessageHandler),
    }
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- æ¶ˆæ¯è·¯ç”±èŒè´£ç‹¬ç«‹ï¼Œå¯å•ç‹¬æµ‹è¯•
- æ”¯æŒåŠ¨æ€æ³¨å†Œå¤„ç†å™¨
- çº¿ç¨‹å®‰å…¨çš„å®ç°

#### ç®€åŒ– Protocol ç»“æ„
```go
// é‡æ„åçš„ Protocol åªè´Ÿè´£æ¶ˆæ¯åˆ›å»ºå’Œç¼–è§£ç ç®¡ç†
type Protocol struct {
    codec MessageCodec
}

func NewProtocol(codecType int) *Protocol {
    codec, err := NewCodec(codecType)
    if err != nil {
        codec = &JSONCodec{} // å®‰å…¨å›é€€
    }
    return &Protocol{codec: codec}
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- èŒè´£å•ä¸€ï¼Œåªç®¡ç†ç¼–è§£ç å™¨
- ç§»é™¤å…¨å±€çŠ¶æ€ï¼Œæ”¯æŒå¤šå®ä¾‹
- æä¾›å®‰å…¨çš„å›é€€æœºåˆ¶

#### å¢åŠ æ¶ˆæ¯åˆ›å»ºè¾…åŠ©æ–¹æ³•
```go
// æä¾›ä¾¿æ·çš„æ¶ˆæ¯åˆ›å»ºæ–¹æ³•
func (p *Protocol) Welcome(text string) *Envelope {
    text = strings.TrimSpace(text)
    return &Envelope{
        Type:    MsgText,
        Ts:      time.Now().UnixMilli(),
        Data:    []byte(text),
        Version: "1.0",
    }
}

func (p *Protocol) CreateAckMessage(status string) *Envelope {
    // æ”¯æŒå¤šç§ç¼–è§£ç å™¨çš„æ¶ˆæ¯åˆ›å»º
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- æä¾›ç±»å‹å®‰å…¨çš„æ¶ˆæ¯åˆ›å»ºæ¥å£
- è‡ªåŠ¨å¡«å……æ—¶é—´æˆ³ç­‰å…ƒæ•°æ®
- æ”¯æŒä¸åŒç¼–è§£ç æ ¼å¼

### 2. Transport å±‚æŠ½è±¡é‡æ„

#### åˆ›å»ºç»Ÿä¸€çš„ Session æŠ½è±¡
```go
// æ–°æ–‡ä»¶: internal/transport/session.go
type SessionState int

const (
    SessionStateActive SessionState = iota
    SessionStateClosed
)

type BaseSession struct {
    id           string
    remoteAddr   string
    state        SessionState
    stateMu      sync.RWMutex
    metadata     map[string]string
    metaMu       sync.RWMutex
    closeHandlers []func()
    closeOnce    sync.Once
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- æä¾›ç»Ÿä¸€çš„ä¼šè¯çŠ¶æ€ç®¡ç†
- æ”¯æŒå…ƒæ•°æ®å­˜å‚¨å’Œæ£€ç´¢
- çº¿ç¨‹å®‰å…¨çš„å®ç°
- æ”¯æŒä¼šè¯ç”Ÿå‘½å‘¨æœŸå›è°ƒ

#### é‡æ„ TCP å®ç°
```go
// ä½¿ç”¨æ–°æŠ½è±¡çš„ TCP ä¼šè¯å®ç°
type tcpSession struct {
    *BaseSession
    conn      net.Conn
    codec     *FrameCodec
    protocol  *protocol.Protocol
    writeMu   sync.Mutex
    closeChan chan struct{}
}

func NewTCPSession(id string, conn net.Conn, codecType int) *tcpSession {
    return &tcpSession{
        BaseSession: NewBaseSession(id, conn.RemoteAddr().String()),
        conn:        conn,
        codec:       NewFrameCodec(),
        protocol:    protocol.NewProtocol(codecType),
        closeChan:   make(chan struct{}),
    }
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- ç§»é™¤å¯¹ä¸šåŠ¡å±‚ chat.Client çš„ä¾èµ–
- ä½¿ç”¨ç»„åˆæ¨¡å¼å¤ç”¨ BaseSession åŠŸèƒ½
- æ”¯æŒå¯é…ç½®çš„ç¼–è§£ç å™¨ç±»å‹
- å®Œæ•´çš„è¯»å†™å¾ªç¯å®ç°

#### ä¼šè¯ç®¡ç†å™¨
```go
type SessionManager struct {
    sessions map[string]Session
    mu       sync.RWMutex
}

func (sm *SessionManager) BroadcastToAll(envelope *protocol.Envelope) {
    sessions := sm.GetAllSessions()
    for _, session := range sessions {
        go func(s Session) {
            _ = s.SendEnvelope(envelope)
        }(session)
    }
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- é›†ä¸­ç®¡ç†æ‰€æœ‰ä¼šè¯
- æ”¯æŒæ‰¹é‡æ“ä½œï¼ˆå¹¿æ’­ç­‰ï¼‰
- éé˜»å¡çš„æ¶ˆæ¯å‘é€

### 3. Gateway å±‚ç®€åŒ–

#### ç§»é™¤ä¸šåŠ¡é€»è¾‘
```go
// æ–°çš„ç®€åŒ– Gateway å®ç°
type SimpleGateway struct {
    sessionManager *SessionManager
    dispatcher     *EnvelopeDispatcher
    handlers       map[string]func(Session, *protocol.Envelope)
}

func (g *SimpleGateway) OnEnvelope(sess Session, msg *protocol.Envelope) {
    // é¦–å…ˆå°è¯•ä¼šè¯çº§åˆ«çš„å¤„ç†å™¨
    if handler, exists := g.handlers[string(msg.Type)]; exists {
        handler(sess, msg)
        return
    }
    
    // å›é€€åˆ°é»˜è®¤åˆ†å‘å™¨
    _ = g.dispatcher.Dispatch(sess, msg)
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- ä¸“æ³¨äºæ¶ˆæ¯è½¬å‘ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- æ”¯æŒå¯æ’æ‹”çš„å¤„ç†å™¨
- æ¸…æ™°çš„åˆ†å±‚è¾¹ç•Œ

## æ¶æ„å¯¹æ¯”

### é‡æ„å‰çš„é—®é¢˜æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Business      â”‚ â”€â”€â”
â”‚                 â”‚   â”‚ è€¦åˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   Transport     â”‚ â”€â”€â”˜
â”‚ (åŒ…å«ä¸šåŠ¡é€»è¾‘)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Protocol      â”‚
â”‚ (èŒè´£æ··ä¹±)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é‡æ„åçš„æ¸…æ™°æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Business      â”‚
â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Gateway       â”‚ â”€â”€â”€ æ¶ˆæ¯è½¬å‘å±‚
â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Transport     â”‚ â”€â”€â”€ ç½‘ç»œä¼ è¾“å±‚
â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Protocol      â”‚ â”€â”€â”€ æ¶ˆæ¯æ ¼å¼å±‚
â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®æ–½è¿‡ç¨‹

### ç¬¬ä¸€é˜¶æ®µï¼šProtocol é‡æ„ âœ…
1. **åˆ›å»º MessageRouter**
   - åˆ†ç¦»æ¶ˆæ¯è·¯ç”±é€»è¾‘
   - æ”¯æŒåŠ¨æ€å¤„ç†å™¨æ³¨å†Œ
   - çº¿ç¨‹å®‰å…¨å®ç°

2. **ç®€åŒ– Protocol ç»“æ„**
   - ç§»é™¤è·¯ç”±ç›¸å…³å­—æ®µ
   - ä¸“æ³¨ç¼–è§£ç å™¨ç®¡ç†
   - æ·»åŠ ä¾¿æ·æ–¹æ³•

3. **ç§»é™¤å…¨å±€çŠ¶æ€**
   - åˆ é™¤ DefaultProtocol å˜é‡
   - æ”¹ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºå®ä¾‹

### ç¬¬äºŒé˜¶æ®µï¼šTransport é‡æ„ âœ…
1. **åˆ›å»º Session æŠ½è±¡**
   - è®¾è®¡ BaseSession åŸºç±»
   - å®ç°çŠ¶æ€ç®¡ç†
   - æ·»åŠ å…ƒæ•°æ®æ”¯æŒ

2. **é‡æ„ TCP å®ç°**
   - ä½¿ç”¨æ–°çš„ Session æŠ½è±¡
   - ç§»é™¤ä¸šåŠ¡å±‚ä¾èµ–
   - å®Œå–„è¯»å†™å¾ªç¯

3. **ç®€åŒ– Gateway**
   - ç§»é™¤ä¸šåŠ¡é€»è¾‘
   - ä¸“æ³¨æ¶ˆæ¯è½¬å‘
   - æ”¯æŒå¯æ’æ‹”å¤„ç†å™¨

### ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå–„å’Œä¼˜åŒ– ğŸš§
1. **é”™è¯¯å¤„ç†**
   - ç»Ÿä¸€é”™è¯¯å®šä¹‰
   - å®Œå–„é”™è¯¯ä¼ æ’­

2. **WebSocket å®ç°**
   - ä½¿ç”¨ç›¸åŒæŠ½è±¡
   - ä¿æŒæ¥å£ä¸€è‡´

3. **æµ‹è¯•è¦†ç›–**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•

## ä¼˜åŒ–æˆæœ

### ä»£ç è´¨é‡æå‡
- **èŒè´£æ¸…æ™°**: æ¯ä¸ªç»„ä»¶èŒè´£å•ä¸€æ˜ç¡®
- **å¯æµ‹è¯•æ€§**: ç»„ä»¶è§£è€¦ï¼Œæ˜“äºå•å…ƒæµ‹è¯•
- **å¯ç»´æŠ¤æ€§**: ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
- **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œæ–°ä¼ è¾“æ–¹å¼

### æ¶æ„æ”¹å–„
- **åˆ†å±‚æ˜ç¡®**: å„å±‚èŒè´£æ¸…æ¥šï¼Œä¾èµ–æ–¹å‘æ­£ç¡®
- **æ¥å£ç»Ÿä¸€**: Session ç­‰æ¥å£å®ç°ä¸€è‡´
- **é…ç½®çµæ´»**: æ”¯æŒè¿è¡Œæ—¶é…ç½®ä¸åŒç¼–è§£ç å™¨

### æ€§èƒ½ä¼˜åŒ–æ½œåŠ›
- **å†…å­˜ç®¡ç†**: BaseSession å¤ç”¨ï¼Œå‡å°‘é‡å¤ä»£ç 
- **å¹¶å‘å®‰å…¨**: å®Œå–„çš„é”æœºåˆ¶ï¼Œæ”¯æŒé«˜å¹¶å‘
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ï¼Œæé«˜ç¨³å®šæ€§

## è®¾è®¡åŸåˆ™ä½“ç°

### å•ä¸€èŒè´£åŸåˆ™ (SRP) âœ…
- **Protocol**: åªè´Ÿè´£æ¶ˆæ¯æ ¼å¼å’Œç¼–è§£ç 
- **MessageRouter**: åªè´Ÿè´£æ¶ˆæ¯è·¯ç”±åˆ†å‘
- **Transport**: åªè´Ÿè´£ç½‘ç»œ I/O ä¼ è¾“
- **Gateway**: åªè´Ÿè´£æ¶ˆæ¯è½¬å‘

### å¼€é—­åŸåˆ™ (OCP) âœ…
- å¯ä»¥æ–°å¢ç¼–è§£ç å™¨è€Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- å¯ä»¥æ–°å¢ä¼ è¾“æ–¹å¼è€Œæ— éœ€ä¿®æ”¹åè®®å±‚
- å¯ä»¥æ–°å¢æ¶ˆæ¯å¤„ç†å™¨è€Œæ— éœ€ä¿®æ”¹è·¯ç”±é€»è¾‘

### ä¾èµ–å€’ç½®åŸåˆ™ (DIP) âœ…
- ä¾èµ–æŠ½è±¡æ¥å£è€Œéå…·ä½“å®ç°
- é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—
- æ”¯æŒä¾èµ–æ³¨å…¥

### æ¥å£éš”ç¦»åŸåˆ™ (ISP) âœ…
- Session æ¥å£èŒè´£æ˜ç¡®
- Gateway æ¥å£ç®€æ´å®ç”¨
- MessageCodec æ¥å£ä¸“ä¸€

## éªŒè¯æ–¹æ³•

### å•å…ƒæµ‹è¯•
```bash
cd /home/runner/work/chat-go/chat-go
go test ./internal/protocol/... -v
go test ./internal/transport/... -v
```

### æ„å»ºæµ‹è¯•
```bash
go build ./internal/...
```

### åŠŸèƒ½éªŒè¯
```bash
go run ./cmd/server
# éªŒè¯ TCP è¿æ¥å’Œæ¬¢è¿æ¶ˆæ¯å‘é€
```

## åç»­æ”¹è¿›è®¡åˆ’

### çŸ­æœŸç›®æ ‡
1. **å®Œå–„ WebSocket å®ç°**: ä½¿ç”¨ç›¸åŒçš„ Session æŠ½è±¡
2. **æ·»åŠ æ›´å¤šæµ‹è¯•**: æé«˜ä»£ç è¦†ç›–ç‡
3. **æ€§èƒ½ä¼˜åŒ–**: å†…å­˜æ± ã€è¿æ¥æ± ç­‰

### ä¸­æœŸç›®æ ‡  
1. **ä¸­é—´ä»¶æ”¯æŒ**: æ¶ˆæ¯å¤„ç†ä¸­é—´ä»¶é“¾
2. **ç›‘æ§æŒ‡æ ‡**: æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†
3. **é…ç½®ç®¡ç†**: æ›´çµæ´»çš„é…ç½®æœºåˆ¶

### é•¿æœŸç›®æ ‡
1. **åˆ†å¸ƒå¼æ”¯æŒ**: å¤šèŠ‚ç‚¹æ¶ˆæ¯è·¯ç”±
2. **æ’ä»¶ç³»ç»Ÿ**: å¯æ’æ‹”çš„åŠŸèƒ½æ¨¡å—
3. **åè®®ç‰ˆæœ¬ç®¡ç†**: å‘åå…¼å®¹çš„åè®®æ¼”è¿›

## æ€»ç»“

æœ¬æ¬¡é‡æ„æˆåŠŸè§£å†³äº†åŸæœ‰æ¶æ„ä¸­çš„å…³é”®é—®é¢˜ï¼š

1. **èŒè´£åˆ†ç¦»**: å„ç»„ä»¶èŒè´£æ˜ç¡®ï¼Œç¬¦åˆå•ä¸€èŒè´£åŸåˆ™
2. **åˆ†å±‚æ¸…æ™°**: å»ºç«‹äº†æ¸…æ™°çš„åˆ†å±‚æ¶æ„
3. **æ¥å£ç»Ÿä¸€**: Session ç­‰æ ¸å¿ƒæ¥å£å®ç°ä¸€è‡´
4. **ä»£ç è´¨é‡**: ç§»é™¤äº†å¤§é‡æ³¨é‡Šä»£ç å’Œç©ºå®ç°
5. **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œæ–°ä¼ è¾“æ–¹å¼

é‡æ„åçš„æ¶æ„æ›´åŠ å¥å£®ã€å¯ç»´æŠ¤ã€å¯æ‰©å±•ï¼Œä¸ºåç»­åŠŸèƒ½å¼€å‘å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚